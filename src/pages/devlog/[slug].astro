---
// src/pages/devlog/[slug].astro
import Base from "../../layouts/Base.astro";
import list from "../../data/devlog.json";

// Eager-load optional Markdown posts so Astro can include them at build time
// Each md file should live at: src/content/devlog/<slug>.md
const mdModules = import.meta.glob("../../content/devlog/*.md", { eager: true });

// Build an index: { [slug]: { default: Component, frontmatter: {...} } }
const mdIndex = Object.fromEntries(
  Object.entries(mdModules).map(([path, mod]) => {
    const slug = path.split("/").pop().replace(/\.md$/,"");
    // @ts-ignore - frontmatter shape depends on your md
    return [slug, mod];
  })
);

// Generate static paths from union of JSON + MD slugs
export function getStaticPaths() {
  const slugsFromJson = list.map(p => p.slug);
  const slugsFromMd   = Object.keys(mdIndex);
  const slugs = Array.from(new Set([...slugsFromJson, ...slugsFromMd]));

  return slugs.map((slug) => {
    const jsonMeta = list.find(p => p.slug === slug);
    // @ts-ignore
    const fm = mdIndex[slug]?.frontmatter ?? {};
    const meta = {
      title: fm.title   ?? jsonMeta?.title   ?? slug,
      date:  fm.date    ?? jsonMeta?.date    ?? "",
      summary: fm.summary ?? jsonMeta?.summary ?? "Devlog post"
    };
    return { params: { slug }, props: { meta } };
  });
}

// Props from getStaticPaths
const { meta } = Astro.props;
const slug = Astro.params.slug;

// Optional markdown content for this slug
// @ts-ignore
const Content = mdIndex[slug]?.default;

const title = meta.title;
const date  = meta.date;
const desc  = meta.summary;
const dateStr = date ? new Date(date).toLocaleDateString("en-GB", { year:"numeric", month:"long", day:"numeric" }) : "";
---

<Base title={title} description={desc}>
  <div class="vt-backdrop" aria-hidden="true"></div>

  <section class="container mx-auto px-4 py-12">
    <a href="/devlog" class="btn btn-secondary mb-6">‚Üê Back to Devlog</a>

    <h1 class="font-heading text-3xl md:text-4xl" data-reveal>{title}</h1>
    {dateStr && <p class="opacity-80 text-sm mt-1">{dateStr}</p>}

    {Content ? (
      <article class="mt-6 prose prose-invert max-w-none" data-reveal>
        <Content />
      </article>
    ) : (
      <article class="card p-6 mt-6" data-reveal>
        <p class="opacity-90">{desc}</p>
        <p class="mt-2 opacity-70 text-sm">Full post coming soon.</p>
      </article>
    )}
  </section>
</Base>
